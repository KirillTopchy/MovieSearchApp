@page "/"
@using MovieSearchFrontend.Models
@inject MovieSearchFrontend.Services.MovieApiClient Api
@inject MovieSearchFrontend.Services.SearchState State

<h3 class="movie-search-title">Movie Search</h3>

<input @bind-value="query"
       @bind-value:event="oninput"
       placeholder="Enter title"
       @onkeypress="HandleKeyPress" />

<button @onclick="Search">
    Search
</button>

@if (State.MoviesSummaries != null)
{
    if (State.MoviesSummaries.Count == 0 && State.SearchPerformed)
    {
        <p><em>No results found.</em></p>
    }
    else
    {
        <ul>
            @foreach (var movieSummary in State.MoviesSummaries)
            {
                <li class="movie-summary">
                    <img src="@movieSummary.Poster" width="50" />
                    <a href="/moviedetails/@movieSummary.ImdbId">@movieSummary.Title (@movieSummary.Year)</a>
                </li>
            }
        </ul>
    }
}

@if (State.SearchHistory != null)
{
    <h4 class="search-history-title">Search History</h4>
    <ul>
        @foreach (var searchHistoryItem in State.SearchHistory)
        {
            <li>@searchHistoryItem.Query (@searchHistoryItem.SearchedAt.ToLocalTime())</li>
        }
    </ul>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="text-danger">@errorMessage</div>
}

@code {
    private string query = string.Empty;
    private string errorMessage = string.Empty;

    private async Task Search()
    {
        errorMessage = string.Empty;
        if (string.IsNullOrWhiteSpace(query))
        {
            State.MoviesSummaries = [];
            State.SearchPerformed = false;
            return;
        }
        try
        {
            var results = await Api.SearchAsync(query);
            State.LastQuery = query;
            State.MoviesSummaries = results;
            State.SearchPerformed = true;

            await LoadHistory();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            State.SearchPerformed = false;
            State.MoviesSummaries = new();
            State.LastQuery = string.Empty;
        }
    }

    private async Task LoadHistory()
    {
        errorMessage = string.Empty;
        try
        {
            State.SearchHistory = await Api.GetHistoryAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            State.SearchHistory = new List<SearchHistory>();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Search();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (State.SearchPerformed && !string.IsNullOrWhiteSpace(State.LastQuery))
        {
            query = State.LastQuery!;
        }

        await LoadHistory();
    }
}

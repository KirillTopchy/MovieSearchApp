@page "/"
@using MovieSearchFrontend.Models
@inject MovieSearchFrontend.Services.MovieApiClient Api
@inject MovieSearchFrontend.Services.SearchState State

<h3 class="movie-search-title">Movie Search</h3>

<div class="search-bar">
    <input @bind-value="query"
           @bind-value:event="oninput"
           placeholder="Enter title"
           @onkeypress="HandleKeyPress" />

    <button class="btn btn-primary btn-sm search-btn"
            @onclick="() => Search(State.CurrentPage)">
        Search
    </button>
</div>

@if (State.MoviesSummaries != null)
{
    if (State.MoviesSummaries.Count == 0 && State.SearchPerformed)
    {
        <p><em>No results found.</em></p>
    }
    else
    {
        <ul>
            @foreach (var movieSummary in State.MoviesSummaries)
            {
                <li class="movie-summary">
                    <img src="@movieSummary.Poster" width="50" />
                    <a href="/moviedetails/@movieSummary.ImdbId">@movieSummary.Title (@movieSummary.Year)</a>
                </li>
            }
        </ul>

        @if (State.TotalResults > State.PageSize)
        {
            <nav class="pagination-controls" aria-label="Search results pages">
                <button class="btn btn-outline-secondary btn-sm"
                        @onclick="PrevPage"
                        disabled="@(State.CurrentPage <= 1)">Prev</button>
                <span class="page-info">Page @State.CurrentPage of @TotalPages</span>
                <button class="btn btn-outline-secondary btn-sm"
                        @onclick="NextPage"
                        disabled="@(State.CurrentPage >= TotalPages)">Next</button>
            </nav>
        }
    }
}

@if (State.SearchHistory != null)
{
    <h4 class="search-history-title">Search History</h4>
    <ul>
        @foreach (var searchHistoryItem in State.SearchHistory)
        {
            <li>@searchHistoryItem.Query (@searchHistoryItem.SearchedAt.ToLocalTime())</li>
        }
    </ul>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="text-danger">@errorMessage</div>
}

@code {
    private string query = string.Empty;
    private string errorMessage = string.Empty;
    private int TotalPages => (int)Math.Ceiling((double)State.TotalResults / State.PageSize);

    private async Task Search(int page)
    {
        errorMessage = string.Empty;
        if (string.IsNullOrWhiteSpace(query))
        {
            State.MoviesSummaries = [];
            State.SearchPerformed = false;
            State.TotalResults = 0;
            State.CurrentPage = 1;
            return;
        }
        try
        {
            var response = await Api.SearchAsync(query, page);
            State.LastQuery = query;
            State.MoviesSummaries = response?.Search ?? [];
            State.TotalResults = response?.TotalResults ?? 0;
            State.PageSize = 10;
            State.CurrentPage = page;
            State.SearchPerformed = true;

            await LoadHistory();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            State.SearchPerformed = false;
            State.MoviesSummaries = new();
            State.TotalResults = 0;
            State.CurrentPage = 1;
            State.LastQuery = string.Empty;
        }
    }

    private async Task PrevPage()
    {
        if (State.CurrentPage > 1)
        {
            await Search(State.CurrentPage - 1);
        }
    }

    private async Task NextPage()
    {
        if (State.CurrentPage < TotalPages)
        {
            await Search(State.CurrentPage + 1);
        }
    }

    private async Task LoadHistory()
    {
        errorMessage = string.Empty;
        try
        {
            State.SearchHistory = await Api.GetHistoryAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            State.SearchHistory = new List<SearchHistory>();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Search(1);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (State.SearchPerformed && !string.IsNullOrWhiteSpace(State.LastQuery))
        {
            query = State.LastQuery!;
        }

        await LoadHistory();
    }
}
